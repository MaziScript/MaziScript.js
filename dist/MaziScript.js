var MaziScript=function(n){"use strict";var e={origin:"",handle:"",title:"",horizontalPart:[],content:{text:[],append:[]},appendix:[],command:[],commandBlock:[],commandPart:[],flag:[],dataJson:[],final:""},t=$.extend(!0,{},e),r=[],a={titlePrefix:!0,replaceBracket:!0,paragraphPrefix:!0,paragraphPrefixNum:2,appendPrefix:!0,appendBreakLine:!1,appendixShow:!1,appendixBreakLine:!1,defaultPublicDataJson:[{magic:23}]},i={title:/[\[【][^\]】]+[\]】]/g,flag:/\{[^\{\}]+\}/g,language:/\n=[》>][^\n]+\n/g,languageBlock:/\n=[》>][^\n]+\n(?:  [^\n:：]+[:：][^\n]+\n)+/g,blockSplit:/([^\:：]+)[:：]([^\:：]+)/,horizontal:/\n[#]+###\n/g,contentAppend:/\n[-]+---\n/,paraPrefix:/[^\n]+\n/g,escape:/[\\\'\*\_\{\}\[\]\(\)\#\+-\.!]/g},o={titlePrefix:"##",paragraphPrefix:"　",contentFlag:"正文",appendixFlag:"附录",languageFlag:"语句"},l=$.extend(a,n||{}),f={removeBeginningChars:function(n,e){return function(){for(var t=n.length,r=0;r<=t;r++){for(var a=!1,i=0;i<=e.length;i++)if(n[0]==e[i]){n=n.substring(1),a=!0;break}if(!a)break}}(),n},removeEndingChars:function(n,e){return function(){for(var t=n.length,r=0;r<=t;r++){for(var a=!1,i=0;i<=e.length;i++)if(n[n.length-1]==e[i]){n=n.substring(0,n.length-1),a=!0;break}if(!a)break}}(),n},removedLength:function(n,e){return typeof n==typeof e=="string"?Math.abs(n.length-e.length):-1},removeBeginEnds:function(n,e){return this.removeEndingChars(this.removeBeginningChars(n,e),e)},removeCrlf:function(n){return this.removeBeginEnds(n,"\n")}};f.data={wordsCount:function(n,t,r){return n="undefined"==typeof n||n,t="undefined"!=typeof t&&n,r="undefined"!=typeof r&&n,(n===!0?e.content.text.length:0)+(t===!0?e.content.append.length:0)+(r===!0?e.title.length:0)}};var c=function(){var n="boolean"!=typeof l.replaceBracket||l.replaceBracket;e.handle=e.handle.replace(i.title,function(t,r,a){return 0!=e.title.length?t:(e.title=t.substring(1,t.length-1),n?(e.final=(l.titlePrefix?o.titlePrefix:"")+e.title,""):(e.final=(l.titlePrefix?o.titlePrefix:"")+t,""))}),f.removeCrlf(e.handle)},p=function(){var n=[],t=[];e.handle.replace(i.horizontal,function(e,r,a){n.push(e.length),t.push(r)});for(var r=1;r<=n.length;r++)r>n.length-1?e.horizontalPart.push("\n"+f.removeCrlf(e.handle.substring(n[r-1]+t[r-1]))+"\n"):e.horizontalPart.push("\n"+f.removeCrlf(e.handle.substring(n[r]+t[r-1],t[r]))+"\n")},u=function(){!function(){for(var n in e.horizontalPart){var t=e.horizontalPart[n],r=-1;t=t.replace(i.flag,function(n,t,a){var i=n.substring(1,n.length-1),l=-1;switch(i){case o.contentFlag:r=l=1;break;case o.appendixFlag:r=l=2;break;case o.languageFlag:r=l=3;break;default:e.flag.push(i),l=-9999}return 1==l||2==l||3==l?"":i}),t=t.replace(i.languageBlock,function(n,t,r){return e.commandBlock.push(f.removeCrlf(n.substring(3))),"\n"}),t=t.replace(i.language,function(n,t,r){return e.command.push(f.removeCrlf(n.substring(3))),"\n"}),1==r||r==-1?!function(){var n=null!=t.match(i.contentAppend);if(n){var r=t;t=t.replace(i.contentAppend,function(n,a,i){return e.content.append.push(f.removeBeginningChars(i.substring(a+n.length),"-\n")),r=t.substring(0,a),"\n"}),e.content.text.push(f.removeCrlf(r))}else e.content.text.push(f.removeCrlf(t)),e.content.append.push("=>undefined")}():2==r?e.appendix.push(f.removeCrlf(t)):3==r?e.commandPart.push(f.removeCrlf(t)):(e.content.text.push(f.removeCrlf(t)),e.content.append.push("=>undefined"))}}()},g=function(){if(l.paragraphPrefix){var n=l.paragraphPrefixNum;for(var t in e.content.text)e.content.text[t]+="\n",e.content.text[t]=e.content.text[t].replace(i.paraPrefix,function(){for(var e="",t=1;t<=n;t++)e+=o.paragraphPrefix;return e}()+"$&"),f.removeCrlf(e.content.text[t])}if(l.appendPrefix)for(t in e.content.append)e.content.append[t]+="\n",e.content.append[t]=e.content.append[t].replace(i.paraPrefix,function(){for(var e="",t=1;t<=n;t++)e+=o.paragraphPrefix;return e}()+"$&"),f.removeCrlf(e.content.append[t])},s=function(){!function(){for(var n in e.content.text)e.final+="\n"+e.content.text[n].replace(i.escape,"\\$&"),e.final+="\n"+e.content.append[n].replace(i.escape,"\\$&")}()},h=function(n){var t=[];if(t.push(function(n){var t=e.commandBlock[n].split("\n"),r=t.shift();for(var a in e.dataJson)e.dataJson[a].name==r&&(r=e.dataJson[a]);"string"==typeof r&&(e.dataJson.push({name:r}),r=e.dataJson[e.dataJson.length-1]);for(a in t)t[a]=f.removeBeginEnds(t[a]," "),function(){var n=t[a].match(i.blockSplit);r[n[1]]=n[2]}()}),n instanceof Array)for(var r=0;r<n.length;r++)t.push(n[r]);for(r=0;r<e.commandBlock.length;r++)for(var a in t)t[a](r);for(r in e.command);};return{parse:function(n){return this.clear(),"undefined"==typeof n?e.origin=e.handle="":"string"==typeof n?(e.origin=e.handle=n,c(),p(),u(),g(),s(),h()):"object"==typeof n&&$.extend(e,n||{}),void 0!=e.final?e.final:""},getOrigin:function(){return e.origin},clear:function(){e=$.extend(!0,{},t)},setPublicData:function(n){r!=[]?r.push({chapterID:"123",data:n}):r=l.defaultPublicDataJson},replacePublicData:function(){this.setPublicData(e.dataJson)},getPublicData:function(){return JSON.stringify(r)},save:function(){return JSON.stringify(e,function(n,e){switch(n){case"don;t want to save":return;default:return e}},"\t")},debug:function(){console.log(JSON.stringify(e,null,"\t"))}}}();